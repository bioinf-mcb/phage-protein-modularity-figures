---
title: "generate_figures"
author: "Bogna Smug"
date: '2022-09-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
node.size.and.color.map = data.table::fread(sprintf("%snode.size.and.color.map.txt", OUTPUT.DATA.PATH)) %>% as.data.frame()
library(cowplot)
```


# Fig 1
```{r}
col1.uniqueness <- "darkgreen"
col2.coverage <- "darkred"
point.size = 3
line.size = 1

annotation.uncertainty.data.vs.cov = data.table::fread(sprintf("%sFigure1/Fig1_Tradeoff_cov.txt", OUTPUT.FIGURES.PATH)) %>% as.data.frame()
p.a=ggplot(data = annotation.uncertainty.data.vs.cov %>%
          mutate(`probability\nthreshold [%]` = as.factor(minimum.probability),
                  annotation.coverage = 100*annotation.coverage)) +
  geom_point(aes(x = annotation.coverage, y = perc.unique.annotation, linetype = `probability\nthreshold [%]`), col = col1.uniqueness, size = point.size) + 
  geom_line(aes(x = annotation.coverage, y = perc.unique.annotation, linetype = `probability\nthreshold [%]`), col = col1.uniqueness, size = line.size) + 
  geom_point(aes(x = annotation.coverage, y = perc.annotated, linetype = `probability\nthreshold [%]`), col = col2.coverage, size = point.size) + 
  geom_line(aes(x = annotation.coverage, y = perc.annotated, linetype = `probability\nthreshold [%]`), col = col2.coverage, size = line.size) + 
  Get.Theme(legend.position = "right") +
  xlab("sequence coverage threshold [%]") +
  theme( axis.title.y.right = element_text(colour = col2.coverage),
         axis.text.y.right = element_text(colour = col2.coverage),
          axis.title.y = element_text(colour = col1.uniqueness),
         axis.text.y = element_text(colour = col1.uniqueness),
           plot.title = element_text(size=14, face="bold", hjust = 0.5)) +
  scale_y_continuous(name = "functional uniqueness \n(% of annotated proteins with hits to a single function)",
                     limits = c(0,101),
                     breaks = seq(0,100,10),
                     sec.axis=sec_axis(~.*1,name="functional coverage \n(% proteins with a hit to any known function)"))  + 
  labs(title = "Impact of sequence coverage on functional annotation")


annotation.uncertainty.data.vs.prob = data.table::fread(sprintf("%sFigure1/Fig1_Tradeoff_prob.txt", OUTPUT.FIGURES.PATH))
p.b=ggplot(data = annotation.uncertainty.data.vs.prob %>%
          mutate(`sequence coverage\nthreshold [%]`  = as.factor(annotation.coverage*100))) +
  geom_point(aes(x = minimum.probability, y = perc.unique.annotation, linetype = `sequence coverage\nthreshold [%]` ), col = col1.uniqueness, size = point.size) + 
  geom_line(aes(x = minimum.probability, y = perc.unique.annotation, linetype = `sequence coverage\nthreshold [%]` ), col = col1.uniqueness, size = line.size) + 
  geom_point(aes(x = minimum.probability, y = perc.annotated, linetype = `sequence coverage\nthreshold [%]` ), col = col2.coverage, size = point.size) + 
  geom_line(aes(x = minimum.probability, y = perc.annotated, linetype = `sequence coverage\nthreshold [%]` ), col = col2.coverage, size = line.size) + 
  Get.Theme(legend.position = "right") +
  xlab("probability [%]") +
  theme( axis.title.y.right = element_text(colour = col2.coverage),
         axis.text.y.right = element_text(colour = col2.coverage),
          axis.title.y = element_text(colour = col1.uniqueness),
         axis.text.y = element_text(colour = col1.uniqueness),
           plot.title = element_text(size=14, face="bold", hjust = 0.5)) +
  scale_y_continuous(name = "functional uniqueness \n(% of annotated proteins with hits to a single function)",
                     limits = c(0,101),
                     breaks = seq(0,100,10),
                     sec.axis=sec_axis(~.*1,name="functional coverage \n(% proteins with a hit to any known function)")) + 
  labs(title = "Impact of hit probability on functional annotation")


annotation.uncertainty.data.vs.eval = data.table::fread(sprintf("%sFigure1/Fig1_Tradeoff_eval.txt", OUTPUT.FIGURES.PATH))
p.c=ggplot(data = annotation.uncertainty.data.vs.eval %>%
          mutate(`sequence coverage\nthreshold [%]`  = as.factor(annotation.coverage*100))) +
  geom_point(aes(x = maximum.eval, y = perc.unique.annotation, linetype = `sequence coverage\nthreshold [%]` ), col = col1.uniqueness, size = point.size) + 
  geom_line(aes(x = maximum.eval, y = perc.unique.annotation, linetype = `sequence coverage\nthreshold [%]` ), col = col1.uniqueness, size = line.size) + 
  geom_point(aes(x = maximum.eval, y = perc.annotated, linetype = `sequence coverage\nthreshold [%]` ), col = col2.coverage, size = point.size) + 
  geom_line(aes(x = maximum.eval, y = perc.annotated, linetype = `sequence coverage\nthreshold [%]` ), col = col2.coverage, size = line.size) + 
  Get.Theme(legend.position = "right") +
  xlab("e-value") +
  theme( axis.title.y.right = element_text(colour = col2.coverage),
         axis.text.y.right = element_text(colour = col2.coverage),
          axis.title.y = element_text(colour = col1.uniqueness),
         axis.text.y = element_text(colour = col1.uniqueness),
           plot.title = element_text(size=14, face="bold", hjust = 0.5)) +
  scale_y_continuous(name = "functional uniqueness \n(% of annotated proteins with hits to a single function)",
                     limits = c(0,101),
                     breaks = seq(0,100,10),
                     sec.axis=sec_axis(~.*1,name="functional coverage \n(% proteins with a hit to any known function)")) +
  scale_x_log10() + 
  labs(title = "Impact of hit e-value on functional annotation")


p.figure <- plot_grid(p.a, p.b, p.c, labels = c("A", "B", "C"), label_size = 25, ncol = 1)
ggsave(p.figure, filename = sprintf("%sFigure1/Figure1.png", OUTPUT.FIGURES.PATH), width = 10, height = 13.5)
  
```

# Fig 2: heatmap of ECODS found in multiple categories
```{r}
text_size = 8
h.domain.occurence.data = data.table::fread(sprintf("%sFigure2/H_domains.txt", OUTPUT.FIGURES.PATH)) %>% 
  as.data.frame() 

h.domain.occurence.data$category <- factor(h.domain.occurence.data$category, levels = phrogs.class.order)

ggplot(h.domain.occurence.data) +
  geom_tile(aes(x=h_name, y = annotation, fill = category)) + 
  Get.Theme(text_size = text_size) +
  theme(axis.text.x = element_text(angle=45, hjust = 1,vjust=1, size = text_size),
               axis.text.y = element_text(hjust = 1,vjust=0.5, size = text_size),
               strip.text.y = element_text(face = "bold", size = 6, angle = 360)) +
  facet_grid(category ~., scales = "free", space = "free", labeller = labeller(category = phrog.class.labels)) + xlab("") + ylab("") +
  guides(fill = "none") +
  scale_fill_manual(values = PHROG.COLOR.MAP)

ggsave(sprintf("%sFigure2/H_domains.jpg", OUTPUT.FIGURES.PATH), width = 7.5, height = 9)
```


# SHINY PLOTS
```{r}
text.size.axis = 6
text.size.panel = 12

  domain.position.plots = list()
  tile.data = data.table::fread(sprintf("%sFigure5/domain.positions.txt", OUTPUT.FIGURES.PATH)) %>% filter(domain.level == "T")

  colormap = tile.data %>% distinct(domain) %>% filter(!(domain %in% c("undetected", "multiple domains")))
  colormap$color = randomcoloR::distinctColorPalette(nrow(colormap))
  colormap = rbind(colormap, data.frame(domain = c("undetected", "multiple domains"), 
                                                  color = c( "#FFFFFF",  "#000000"), stringsAsFactors = FALSE))
  colm = colormap$color
  names(colm) = colormap$domain
        
      for (this.annotation in most.mosaic.annotations) {
        this.tile.data = tile.data %>% 
          filter(annotation == this.annotation)  %>% 
          mutate(annotation = this.annotation) %>%
          arrange(row)
        
        gg_rect = Show.Domain.Position.Within.Data(
          this.tile.data,
          colm, 
          theme.no.verical) +
          #scale_y_discrete(breaks =this.tile.data$qname, labels = this.tile.data$family) +
          
            theme(strip.text.x = element_text(size = text.size.panel), 
            legend.position = "none") +
              theme(
                axis.title.x = element_text(size = text.size.axis),
                axis.title.y = element_text(size = text.size.axis),
                #axis.text.x = element_blank(),
                axis.text.y = element_blank(),
                #axis.text.y = element_text(size = text.size.axis),
                #axis.ticks.x = element_blank(),
                axis.ticks.y = element_blank())
                
        domain.position.plots[[this.annotation]] =  gg_rect
  }
  
  
  #Create a subfigure with legend only, take only the most frequent
  colormap.with.names = colormap %>% inner_join(tile.data %>% 
                                                 group_by(domain_name) %>%
                                                 mutate(num_qnames = n_distinct(qname)) %>%
                                                 filter(num_qnames >= 3) %>%
                                                 distinct(domain, domain_name)) %>% distinct(color, domain_name)
  colm.with.names = colormap.with.names$color
  names(colm.with.names) = colormap.with.names$domain_name
  
  g.dummy = ggplot(tile.data, aes(x=qname, y = domain, fill = domain_name)) + geom_col() + 
    scale_fill_manual(values = colm.with.names, name = 'Domain topology') +
    theme(legend.margin =margin(r=0,l=0,t=0,b=0)) +
    guides(fill=guide_legend(ncol=4))
  
  leg <- ggpubr::get_legend(g.dummy, position = "right")
  ggleg = ggpubr::as_ggplot(leg)
#grid::widthDetails(leg)
#grid::heightDetails(leg)


  
    ncol = ceiling(length(domain.position.plots)/2)
    jpeg(sprintf("%sFigure5/domain.positions.jpg", OUTPUT.FIGURES.PATH), 
         width = 50, 
         height = 30, units = "cm", res = 300)
    
    ggpubr::ggarrange(
      egg::ggarrange(plots = domain.position.plots,
                     ncol = ncol, nrow = 2),
      ggleg,
      nrow = 2,
      heights = c(2,1))
      #legend.prob = ggleg,
      #nrow = 1,
      #legend = "bottom")
  dev.off()
  

```

# Fig. 4: diversity
```{r}
diversity = data.table::fread(sprintf("%sFigure1/Fig1_b_Diversity_vs_mosaicism.txt", OUTPUT.FIGURES.PATH))


Fig4a = ggplot(diversity, aes(x=prop.proteins.with.ecod.hit)) + 
  geom_histogram(fill = "blue", position="dodge", bins = 20, color = "black") + 
  theme_minimal() + 
  labs(x = "Proportion of proteins with ECOD hit",
       y = "Number of functional classes")


# label the ones that have many families or fold types

diversity.ok.ecod = diversity %>% filter(!poorly.ecod.annotated)
diversity.ok.ecod$label <- ""
is.diverse.enough.for.label <- 
  diversity.ok.ecod$num.families >= plotting.thr.fam | 
  diversity.ok.ecod$num.topology.combinations >= plotting.thr.ft
diversity.ok.ecod$label[is.diverse.enough.for.label] <- diversity.ok.ecod$annotation[is.diverse.enough.for.label]

Fig4b = ggplot(diversity.ok.ecod, aes(x = num.families, y = num.topology.combinations, colour = category)) + 
  geom_point() + 
  scale_x_log10() + 
  ggrepel::geom_label_repel(aes(label = label), size = 3) + 
  scale_colour_manual(values = PHROG.COLOR.MAP) + 
  labs(x = "Number of families", y = "Number of fold combinations") + 
  guides(colour = "none") + theme_minimal()

p.panelab <- plot_grid(Fig4a, Fig4b, labels = c("A", "B"), label_size = 8, ncol = 2, rel_widths  = c(1,2))
p.panelab

# Fig 4c
# plot the relation between genetic and structural diversity

levels = c("mean.num.t", 
           "prop.mosaic.pairs.sequence.thr0p1",
           "prop.mosaic.pairs.sequence.thr0p3",
           "prop.mosaic.pairs.sequence.thr0p5", 
           "prob.mosaicism")
diversity.top = data.table::fread(sprintf("%sFigure4/moaicism.top.diverse.classes.txt", OUTPUT.FIGURES.PATH)) %>%
  filter(proportion %in% levels)
diversity.top = diversity.top %>% mutate(proportion = factor(proportion, levels = levels))
diversity.levels <- levels(diversity.top$proportion)
diversity.labeller <- character(length(diversity.levels))
diversity.labeller[diversity.levels == "mean.num.t"] <- "Mean number of folds\nper fold architecture"
diversity.labeller[diversity.levels == "prop.mosaic.pairs.sequence.thr0p1"] <- "Proportion of mosaic pairs\nby sequence (10%)"
diversity.labeller[diversity.levels == "prop.mosaic.pairs.sequence.thr0p3"] <- "Proportion of mosaic pairs\nby sequence (30%)"
diversity.labeller[diversity.levels == "prop.mosaic.pairs.sequence.thr0p5"] <- "Proportion of mosaic pairs\nby sequence (50%)"
diversity.labeller[diversity.levels == "prob.mosaicism"] <- "Prob. of domain mosaicism\nbetween fold architectures\nif sharing a fold"
names(diversity.labeller) <- diversity.levels

p <- ggplot(diversity.top, aes(y = annotation, x = value, fill = category)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  facet_grid(category ~ proportion, scales = "free", space = "free_y", 
                    labeller = labeller(class = phrog.class.labels, proportion = diversity.labeller)) +
  scale_fill_manual(values = PHROG.COLOR.MAP) + theme_minimal() + 
  theme(strip.text.y = element_text(face = "bold", size = 7, angle = 360)) + 
  labs(x = "", y = "")
p.most.diverse <- p + guides(fill = "none")
p.most.diverse

p.fig4 <- plot_grid(p.panelab, p.most.diverse, ncol = 1, labels = c("", "C"), label_size = 8)
p.fig4.filename <- sprintf("%sFigure4/Figure4.png", OUTPUT.FIGURES.PATH)
ggsave(p.fig4.filename, p.fig4, width = 12, height = 8)


## supplementary version
# Fig 4c
# plot the relation between genetic and structural diversity

levels.supp = c("mean.num.t.per.prot", 
           "prob.mosaicism.if.sharing.fold.and.multi.x.family.measure")
diversity.top.supp = data.table::fread(sprintf("%sFigure4/moaicism.top.diverse.classes.txt", OUTPUT.FIGURES.PATH)) %>%
  filter(proportion %in% levels.supp)
diversity.top.supp = diversity.top.supp %>% mutate(proportion = factor(proportion, levels = levels.supp))
diversity.levels.supp <- levels(diversity.top.supp$proportion)
diversity.labeller <- character(length(diversity.levels.supp))
diversity.labeller[diversity.levels.supp == "mean.num.t.per.prot"] <- "Mean number of folds\nper protein family"
diversity.labeller[diversity.levels.supp == "prob.mosaicism.if.sharing.fold.and.multi.x.family.measure"] <- "Probability of domain mosaicism\nbetween protein families \nif sharing a fold \nand having multiple X domains"

names(diversity.labeller) <- diversity.levels.supp

p <- ggplot(diversity.top.supp, aes(y = annotation, x = value, fill = category)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  facet_grid(category ~ proportion, scales = "free", space = "free_y", 
                    labeller = labeller(class = phrog.class.labels, proportion = diversity.labeller)) +
  scale_fill_manual(values = PHROG.COLOR.MAP) + theme_minimal() + 
  theme(strip.text.y = element_text(face = "bold", size = 7, angle = 360)) + 
  labs(x = "", y = "")
p.most.diverse.supp <- p + guides(fill = "none")
p.most.diverse.supp

p.fig4.filename <- sprintf("%sFigure4/Figure4c_supplementary_version.png", OUTPUT.FIGURES.PATH)
ggsave(p.fig4.filename, p.most.diverse.supp, width = 12, height = 8)


```


# FIG 3 CD mosaic unknowns
```{r}
## unknowns
table.unknowns.seq.filename <- sprintf("%sFigure3/table-unknown-seq.txt", OUTPUT.FIGURES.PATH) 
table.unknowns.seq <- data.table::fread(table.unknowns.seq.filename) %>%
  filter(weight >= 15) %>%
  arrange(weight)

# plot sequence
table.unknowns.seq$category[table.unknowns.seq$category == "unknown"] <- "other"
table.unknowns.seq$annotation <- factor(table.unknowns.seq$annotation, levels = unique(table.unknowns.seq$annotation))

p.seq <- ggplot(data=table.unknowns.seq, aes(x=annotation, y=weight, fill=category)) + 
  geom_bar(stat="identity") + 
  scale_fill_manual(values = PHROG.COLOR.MAP) + 
  theme_minimal() + 
  theme(legend.text=element_text(size=6)) + 
  labs(x = "", y = "weighted occurrence", fill = "category") + 
  coord_flip()
p.seq
ggsave(filename = sprintf("%sFigure3/panelC.jpg", OUTPUT.FIGURES.PATH) , p.seq, width = 6, height = 5)


# plot sequence: all not only mosaic
table.all.unknowns.seq.filename <- sprintf("%sFigure3/table-all-unknown-seq.txt", OUTPUT.FIGURES.PATH) 
table.all.unknowns.seq <- data.table::fread(table.all.unknowns.seq.filename) %>%
  filter(weight >= 50) %>%
  arrange(weight)

table.all.unknowns.seq$category[table.all.unknowns.seq$category == "unknown"] <- "other"
table.all.unknowns.seq$annotation <- factor(table.all.unknowns.seq$annotation, levels = unique(table.all.unknowns.seq$annotation))

p.seq.supp <- ggplot(data=table.all.unknowns.seq, aes(x=annotation, y=weight, fill=category)) + 
  geom_bar(stat="identity") + 
  scale_fill_manual(values = PHROG.COLOR.MAP) + 
  theme_minimal() + 
  theme(legend.text=element_text(size=6)) + 
  labs(x = "", y = "weighted occurrence", fill = "category") + 
  coord_flip() + 
  #ggtitle("Low confidence annotations of all unannotated proteins.") +
  scale_y_log10()
p.seq.supp
ggsave(filename = sprintf("%sFigure3/panelC_supplementary.jpg", OUTPUT.FIGURES.PATH) , p.seq.supp, width = 10, height = 10)

# plot ecod
table.unknowns.ecod.filename <- sprintf("%sFigure3/table-unknown-ecod.txt", OUTPUT.FIGURES.PATH)
table.unknowns.ecod <- fread(table.unknowns.ecod.filename)

ecod.table <- table.unknowns.ecod %>% 
  filter(freq>=0.02) %>%
  arrange(freq)
ecod.table$t_name <- factor(ecod.table$t_name, levels = unique(ecod.table$t_name))

ecod.table$h.index <- sapply(1:nrow(ecod.table), function(index){
  this.topology <- ecod.table$t_id[index]
  this.topology.h.index <- strsplit(this.topology, ".", fixed = T)[[1]]
  this.topology.h.index <- this.topology.h.index[-length(this.topology.h.index)]
  this.topology.h.index <- as.character(paste(this.topology.h.index, collapse = "."))
})
ecod.table = ecod.table %>%
    left_join(ecod_id_to_names_map %>% filter(level == "H") %>% select(h.index = id, h_name = name))
display.h.name <- ecod.table$h_name
display.h.name[ecod.table$t_name == ecod.table$h_name] <- "same"
display.t.name <- sprintf("%s\n(H: %s)", ecod.table$t_name, display.h.name)

getPalette <- colorRampPalette(RColorBrewer::brewer.pal(9, "Set1"))
no.hom <- length(unique(ecod.table$h_name))
p <- ggplot(data=ecod.table, aes(x=t_name, y=freq, fill=h_name)) + geom_bar(stat="identity")
p <- p + scale_fill_manual(values = getPalette(no.hom))
p <- p + scale_x_discrete(breaks = ecod.table$t_name, labels = display.t.name)
p <- p + theme_minimal()
p <- p + labs(x = "", y = "frequency")
p <- p + guides(fill = "none")
p.ecod <- p + coord_flip()
p.ecod

p.panelc.filename <- sprintf("%sFigure3/panelCD_unknowns.jpg", OUTPUT.FIGURES.PATH)
p.panelc <- plot_grid(p.seq, p.ecod, labels = c("C", "D"), label_size = 25, ncol = 2)
ggsave(filename = p.panelc.filename, p.panelc, width = 12, height = 6)
```

# Fig 3c NEW
```{r}
table.unknown.seq.functions = data.table::fread(sprintf("%sFigure3/table.seq.functions.new.txt", OUTPUT.FIGURES.PATH))

table.unknown.seq.functions = table.unknown.seq.functions %>%
  filter(weight >= 50) %>%
  group_by(annotation) %>%
  mutate(sum.weight = sum(weight)) %>%
  arrange(sum.weight)

table.unknown.seq.functions$category[table.unknown.seq.functions$category == "unknown"] <- "other"
table.unknown.seq.functions$annotation <- factor(table.unknown.seq.functions$annotation, 
                                                 levels = unique(table.unknown.seq.functions %>% pull(annotation) %>% unique()))

  
new.3c=ggplot(data=table.unknown.seq.functions, aes(x=annotation, y=weight, fill=category, alpha = mosaic)) + 
  geom_bar(stat="identity", position = position_dodge2(width = 0.9, preserve = "single")) + 
  scale_fill_manual(values = PHROG.COLOR.MAP) + 
  #facet_grid(.~mosaic) +
  theme_minimal() + 
  theme(legend.text=element_text(size=6)) + 
  labs(x = "", y = "weighted occurrence", fill = "category") + 
  coord_flip() +
  scale_y_log10()
ggsave(filename = sprintf("%sFigure3/new_3c.jpg", OUTPUT.FIGURES.PATH) , new.3c, width = 15, height = 10)

```

# Fig 3d new
```{r}
domains.within.proteins = data.table::fread(file = sprintf("%sFigure3/domains-in-known-and-unknown.txt", OUTPUT.FIGURES.PATH))

included.ecods = domains.within.proteins %>% 
  filter(num.families >= 25) %>%
  #filter((freq>=0.005 & mosaic == "Proteins with mosaic signal") | (freq>=0.001 & mosaic == "Proteins with no mosaic signal")) %>%
  pull(t_id) %>% unique()

ecod.table <- domains.within.proteins %>% 
  filter(t_id %in% included.ecods)%>%
  arrange(num.families)

display.h.name <- ecod.table$h_name
display.h.name[ecod.table$t_name == ecod.table$h_name] <- "same"
display.t.name <- sprintf("%s\n(H: %s)", ecod.table$t_name, display.h.name)

getPalette <- colorRampPalette(RColorBrewer::brewer.pal(9, "Set1"))
no.hom <- length(unique(ecod.table$h_name))
p <- ggplot(data=ecod.table, aes(x=t_name, y=num.families, fill=h_name, alpha = mosaic)) + geom_bar(stat="identity", position = "dodge")
p <- p + scale_fill_manual(values = getPalette(no.hom))
p <- p + scale_x_discrete(breaks = ecod.table$t_name, labels = display.t.name)
p <- p + theme_minimal()
p <- p + labs(x = "", y = "Number of families within this domain")
p <- p + guides(fill = "none") + scale_alpha_manual(values = c("Proteins with mosaic signal" = 0.9, "Proteins with no mosaic signal" = 0.3))
p.ecod <- p + coord_flip()
p.ecod

#p.panelc <- plot_grid(p.seq, p.ecod, labels = c("C", "D"), label_size = 25, ncol = 2)
ggsave(filename = sprintf("%sFigure3/new_3d.jpg", OUTPUT.FIGURES.PATH), p.ecod, width = 12, height = 6)
```


# Sup Fig1 : Annotation melting: connecting categories that have high conditional probabilities of annotating the same proteins
```{r}
annotation.network = data.table::fread(sprintf("%sFigure1/Fig1b_Phrogs_melting.txt", OUTPUT.FIGURES.PATH)) %>% as.data.frame()

coverages = unique(annotation.network$annotation.coverage)
for (this.cov in coverages) {
  
  annotation.network.this.cov = annotation.network %>% 
    filter(annotation.coverage == this.cov) %>%
     # only include categories that appear reasonably often in our data
    filter(from %in% node.size.and.color.map$node &
           to %in% node.size.and.color.map$node)


  annotated_net = Annotate_Graph(data.for.network = annotation.network.this.cov, 
                                edge.colors = NULL,
                                node.color.map = node.size.and.color.map %>% distinct(node, color),
                                node.size.map = node.size.and.color.map %>% distinct(node, size),
                                line.color.variable = "max.prob.conditional",
                                vertex.size = 1)
  
  if (this.cov > 0.5) {
    width = 15
    height = 15
    cex=0.5
  } else {
    width = 30
    height = 20
    cex = 0.2
  }
  
  g=VisualiseGGnetwork(annotated_net, label_size = 2, cex = cex)
  print(g)
  ggsave(sprintf("%sFigure1/Fig1b_Phrogs_melting_cov%s.jpg", OUTPUT.FIGURES.PATH, this.cov), g, width = width, height = height, units = "cm")
  
}
```


```{r}
ggplot(diversity.data %>%
  tidyr::gather(key = "diversity.stat", value = "number", num.families, num.topologies, num.topology.combinations)) +
  geom_col(aes(x = annotation, y = number, fill = category, alpha = diversity.stat), position = "dodge") +
  Get.Theme(text_size = 4, legend.position = "bottom") +
  facet_grid(. ~category, scales = "free", space = "free") + xlab("") + ylab("") +
  guides(fill = "none") +
  scale_alpha_manual(values = c("num.families" = 1, "num.topologies" = 0.7, "num.topology.combinations" = 0.4)) +
  scale_fill_manual(values = PHROG.COLOR.MAP)
ggsave(sprintf("%sFigure1/Fig1_Diversity.jpg", OUTPUT.FIGURES.PATH), width = 1.3*FIG.WIDTH, height = FIG.HEIGHT, units = "cm")

ggplot(diversity.data, aes(x = num.families, y = num.topology.combinations)) +
  geom_point(aes(col = category), size = 2) +
  geom_text(aes(label = annotation, col = category), nudge_y = 1, size = 1.5) +
  Get.Theme(text_size = 4, legend.position = "bottom") +
  guides(col = "none") +
  scale_color_manual(values = PHROG.COLOR.MAP)
  #facet_grid(. ~category, scales = "free", space = "free") 
  #geom_smooth()
ggsave(sprintf("%sFigure1/Fig1_Diversity_vs_mosaicism.jpg", OUTPUT.FIGURES.PATH), width = 1.3*FIG.WIDTH, height = FIG.HEIGHT, units = "cm")
```

# Fig 2b: network of annotations on low cov: connect the ones that appear at least in 3 families 
```{r}
annotation.network.low.cov = data.table::fread(sprintf("%sFigure2/Fig2b_shared_annotations.txt", OUTPUT.FIGURES.PATH))

annotation.network.low.cov = annotation.network.low.cov %>% 
    filter(from %in% node.size.and.color.map$node &
           to %in% node.size.and.color.map$node) 


  annotated_net = Annotate_Graph(data.for.network = annotation.network.low.cov %>% mutate(weight = 1), 
                                edge.colors = NULL,
                                node.color.map = node.size.and.color.map %>% distinct(node, color),
                                node.size.map = node.size.and.color.map %>% distinct(node, size),
                                line.color.variable = "weight",
                                vertex.size = 1)
  
  g=VisualiseGGnetwork(annotated_net, label_size = 2, cex = 0.2)
  print(g)
  ggsave(sprintf("%sFigure2/Fig2b_Phrogs_melting_low_cov.jpg", OUTPUT.FIGURES.PATH, this.cov), g, width = 30, height = 30, units = "cm")

```
# Mosaicism between and within annotations
```{r}
mosaicism.between.and.within.annotations = data.table::fread(file = sprintf("%sFigure3/Fig3b_mosaicism_between_and_within_f.txt", OUTPUT.FIGURES.PATH))
ggplot(mosaicism.between.and.within.annotations %>%
         mutate(annotation.x = factor(annotation.x, levels = mosaicism.between.and.within.annotations %>% 
                                        distinct(category.x, annotation.x) %>%
                                        arrange(category.x, annotation.x) %>%
                                        pull(annotation.x))) %>%
         mutate(annotation.y = factor(annotation.y, levels = mosaicism.between.and.within.annotations %>%  
                                        distinct(category.x, annotation.x) %>%
                                        arrange(category.x, annotation.x) %>%
                                        pull(annotation.x)))) +
  geom_tile(aes(x = annotation.x, y = annotation.y, fill = type)) +
  #facet_grid(category.x ~ ., space = "free", scales = "free") +
  guides(fill = "none") +
  scale_fill_manual(values = c(PHROG.COLOR.MAP, "different.cat" = "#000000","not mosaic" =  "#F5F5F5")) +
  Get.Theme() + 
  theme(panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.y = element_blank(),
  panel.grid.minor.y = element_blank()) + xlab("") + ylab("")
ggsave(sprintf("%sFigure3/Fig3b_mosaicism_between_and_within_f.jpg", OUTPUT.FIGURES.PATH, this.cov), width = 30, height = 30, units = "cm")
```

# Mosaicism between functions
```{r}
network.mosaicism.between.annotations = data.table::fread(sprintf("%sFigure3/Fig3a_Mosaicism_between_functions.txt", OUTPUT.FIGURES.PATH))
  annotated_net_mbf = Annotate_Graph(data.for.network = network.mosaicism.between.annotations %>% mutate(weight = 1), 
                                edge.colors = NULL,
                                node.color.map = node.size.and.color.map %>% select(node, color),
                                node.size.map = node.size.and.color.map %>% select(node, size),
                                line.color.variable = "weight",
                                vertex.size = 1)

  g = VisualiseGGnetwork(annotated_net_mbf, label_size = 3)
  ggsave(sprintf("%sFigure3/Fig3a_Mosaicism_between_functions.jpg", OUTPUT.FIGURES.PATH), g, width = width*0.7, height = height*0.7)
```


# Mosaicism within functions
```{r}
domain.sharing.par.number.data.most.popular.annotations.only = data.table::fread(sprintf("%sFigure4/Fig4a_Mosaicism_within_class_min_3_family_pairs.txt", OUTPUT.FIGURES.PATH))
ggplot(domain.sharing.par.number.data.most.popular.annotations.only) +
  geom_col(aes(x = annotation, y = prob.moisaicism.cond.shared.f, fill = category)) +
  facet_grid(.~category, scales = "free",  space = "free_x") +
  guides(fill = "none") +
  Get.Theme(text_size = 4) +
  scale_fill_manual(values = PHROG.COLOR.MAP) + xlab("") + ylab("P(dishared X domain | shared F domain & multiple X domains)")
ggsave(sprintf("%sFigure4/Fig4a_Mosaicism_within_class_min_3_family_pairs.jpg", OUTPUT.FIGURES.PATH), width = 1.3*FIG.WIDTH, height = FIG.HEIGHT, units = "cm")
```


# Density plot: Figure 3a
```{r} 
annotated.hhr.table = data.table::fread(sprintf("%sFigure3/cov.vs.pident.txt", OUTPUT.FIGURES.PATH))
spectral.scale = rev(RColorBrewer::brewer.pal(11, "Spectral"))
fig3a = ggplot(annotated.hhr.table, aes(x=pident, y=max.cov)) + 
  stat_binhex(bins = 50) + 
  scale_fill_gradientn(colours = spectral.scale) + 
  scale_x_continuous(limits = c(0,1)) + 
  scale_y_continuous(limits = c(0,1)) + 
  theme_bw() + 
  labs(x = "Percentage identity", y = "Pairwise sequence coverage", fill = "no. pairs")
ggsave(sprintf("%s/Figure3/panelA_pairwise-seq.png", OUTPUT.FIGURES.PATH), fig3a,  width = 5, height = 4)
```

