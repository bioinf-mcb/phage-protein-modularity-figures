

```{r}
# run config 
source("~/MGG Dropbox/Projects/divRBP/paper-figures/scripts/1.config.R")
#run  prepare tables
SHINY_DATA_PATH = "/Users/bognasmug/MGG Dropbox/Projects/divRBP/shiny-server/Phage.Domain.Lookup/data/"


ecod.domains.hits = data.table::fread(sprintf("%secod.domains.hits.txt",OUTPUT.DATA.PATH))
families = data.table::fread(file = sprintf("%sfamilies.txt", OUTPUT.DATA.PATH))
ecod_id_to_names_map = data.table::fread(sprintf("%secod_id_to_names_map.txt",OUTPUT.DATA.PATH)) %>% as.data.frame()
surely.annotated.proteins.including.multi.annot = data.table::fread( sprintf("%ssurely.annotated.proteins.including.multi.annot",OUTPUT.DATA.PATH))
included.category.sizes = data.table::fread(sprintf("%sincluded.category.sizes",OUTPUT.DATA.PATH))
# disregard the ones with multiple annotations
surely.annotated.proteins = surely.annotated.proteins.including.multi.annot %>% filter(num.annots == 1 & include == "TRUE")
```

```{r}
surely.annotated.ecod.domains = ecod.domains.hits %>% 
  select(qname, qstart, qend, qlength, sstart, send, slength, x_id, h_id, t_id, f_id, minimum.prob) %>%
  # note that some families may be unclassified i.e. d_id = NA
  inner_join(surely.annotated.proteins)  %>%  # take the conservatively defined domains onlu
  inner_join(included.category.sizes, by = c("annotation.index", "annotation", "category", "structural", "annotation.coverage")) 


surely.annotated.ecod.domains.high.confidence =  surely.annotated.ecod.domains %>%
  filter(minimum.prob == MINIMUM.PROB.FOR.DOMAIN) %>%
  select(-minimum.prob) 
```


#SHINY PLOTS: DOMAINS WITHIN FUNCTIONS
```{r}

tile.data.list = list()
tile.data.multi.list = list()
i=0
domain_levels = c("T", "H")
for (this.domain.level in domain_levels) {
this.domain.level.id = paste0(tolower(this.domain.level), "_id")
for (this.category in unique(surely.annotated.ecod.domains.high.confidence$category)) {
  domain.position.plots.this.category = list()
  domain.combination.plots.this.category = list()
  this.category.annotations = surely.annotated.ecod.domains.high.confidence %>% 
    filter(category == this.category) %>% 
    pull(annotation) %>% 
    unique()

  for (this.annotation in this.category.annotations) {
    domains.within.this.annotation = surely.annotated.ecod.domains.high.confidence %>% 
      filter(category == this.category & annotation == this.annotation) %>% 
        select(qname, annotation, qlength, qstart, qend, domain = this.domain.level.id)  %>% 
        group_by(qname) %>%
        arrange(qstart) %>%
      # HACK , sort by teh first domain
        mutate(family =  domain[1],
               num.domains = n_distinct(domain),
               all.domains = paste0(sort(unique(domain)), collapse = "_and_")) %>%
        ungroup() 
    
    if (nrow(domains.within.this.annotation) > 0) {
      i=i+1
      tile.data = Get.Domain.Positions.Data(
        domains.within.this.annotation) %>%
        mutate(annotation = this.annotation,
               category = this.category,
               domain.level = this.domain.level)
        tile.data.list[[i]] = tile.data
        
      tile.data.multi = Get.Domain.Positions.Data(
        domains.within.this.annotation %>%
          filter(num.domains > 1) %>%
          group_by(all.domains) %>%
          mutate(repr.qname = qname[1]) %>%
          ungroup() %>%
          filter(repr.qname == qname)) %>%
        mutate(annotation = this.annotation,
               category = this.category,
               domain.level = this.domain.level)
      tile.data.multi.list[[i]] = tile.data.multi
          
    }
  }
}
}

    tile.data = do.call('rbind', tile.data.list) %>%
      left_join(ecod_id_to_names_map %>% 
                  select(domain = id, domain_name = name, domain.level = level) %>%
                  rbind(expand.grid(domain.level = unique(ecod_id_to_names_map$level), 
                                    domain = c("undetected", "multiple domains")) %>%
                                   mutate(domain_name = domain)))
    
    tile.data.multi = do.call('rbind', tile.data.multi.list) %>%
      left_join(ecod_id_to_names_map %>% 
                  select(domain = id, domain_name = name, domain.level = level) %>%
                  rbind(expand.grid(domain.level = unique(ecod_id_to_names_map$level), 
                                    domain = c("undetected", "multiple domains")) %>%
                                   mutate(domain_name = domain)))
    
    data.table::fwrite(tile.data.multi, sprintf("%smultiple_domains.domain.positions.txt", SHINY_DATA_PATH))
    data.table::fwrite(tile.data, sprintf("%sdomain.positions.txt", SHINY_DATA_PATH))

      

```
